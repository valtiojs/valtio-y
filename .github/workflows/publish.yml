name: Publish to npm

on:
  release:
    types: [created]

permissions:
  contents: read
  id-token: write  # Required for npm provenance

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      # --- 1. Checkout -------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # --- 2. Setup Bun ------------------------------------------------------
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1

      # --- 3. Install dependencies -------------------------------------------
      - name: Install dependencies
        run: bun install --frozen-lockfile --ignore-scripts

      # --- 4. Build all packages ---------------------------------------------
      - name: Build
        run: bun run build

      # --- 5. Type check -----------------------------------------------------
      - name: Typecheck
        run: bun run typecheck

      # --- 6. Lint -----------------------------------------------------------
      - name: Lint
        run: bun run lint

      # --- 7. Test -----------------------------------------------------------
      - name: Test
        timeout-minutes: 3
        run: bun run test

      # --- 8. Publish to npm with provenance ---------------------------------
      - name: Publish to npm
        run: cd valtio-y && npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
